<div class="container">
  <h1>Review Rankings for Round <%= @judging_round.round_number %></h1>

  <div class="card mt-4">
    <div class="card-header">
      <h3>Entry Rankings</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Entry ID</th>
              <th>Title</th>
              <th>Average Rank</th>
              <th>Individual Rankings</th>
              <th>Select for Next Round</th>
            </tr>
          </thead>
          <tbody>
            <% @judging_round.entries.distinct.each do |entry| %>
              <tr>
                <td><%= entry.id %></td>
                <td><%= entry.title %></td>
                <td>
                  <%= @judging_round.average_rank_for_entry(entry) || 'No rankings' %>
                </td>
                <td>
                  <% entry.entry_rankings.where(judging_round: @judging_round).each do |ranking| %>
                    <div>
                      <%= content_tag(:span,
                        display_email(ranking.user.email),
                        data: {
                          'bs-toggle': 'tooltip',
                          'bs-html': 'true',
                          'bs-title': "#{h(ranking.user.display_name)}<br>#{h(display_email(ranking.user.email))}"
                        }
                      ) %> : <%= ranking.rank || 'Not ranked' %>
                      <% if ranking.internal_comments.present? %>
                        <button class="btn btn-sm btn-outline-info ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#comments-<%= ranking.id %>">
                          View Comments
                        </button>
                        <div class="collapse mt-2" id="comments-<%= ranking.id %>">
                          <div class="card card-body">
                            <strong>Internal Comments:</strong>
                            <p><%= ranking.internal_comments %></p>
                            <% if ranking.external_comments.present? %>
                              <strong>External Comments:</strong>
                              <p><%= ranking.external_comments %></p>
                            <% end %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </td>
                <td class="text-center">
                  <%= form_with(url: select_for_next_round_container_contest_description_contest_instance_judging_round_entry_ranking_path(
                    @container, @contest_description, @contest_instance, @judging_round, entry.entry_rankings.find_by(judging_round: @judging_round)
                  ), method: :patch) do |f| %>
                    <div class="form-check">
                      <%= check_box_tag 'selected_for_next_round', '1',
                          entry.entry_rankings.where(judging_round: @judging_round, selected_for_next_round: true).exists?,
                          class: 'form-check-input',
                          data: {
                            turbo_frame: 'flash',
                            action: 'change->form#submit'
                          }
                      %>
                    </div>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <%= link_to 'Back to Judging Assignments',
        container_contest_description_contest_instance_judging_assignments_path(
          @container, @contest_description, @contest_instance
        ),
        class: 'btn btn-secondary' %>
  </div>
</div>

<% content_for :javascript do %>
  <script>
    document.addEventListener('turbo:load', function() {
      // Enable tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      })

      // Auto-submit form on checkbox change
      document.querySelectorAll('input[type="checkbox"][data-action="change->form#submit"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          this.closest('form').submit()
        })
      })
    })
  </script>
<% end %>
