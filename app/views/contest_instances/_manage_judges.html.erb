<div id="<%= dom_id(contest_instance, :judges) %>">
  <h2>Total Judging Rounds:<%= contest_instance.actual_judging_rounds_count %></h2>
  <%= render 'management_links' %>
  <div class="judging-rounds">
    <% contest_instance.judging_rounds.order(:round_number).each do |round| %>
      <div class="card mb-3 border-<%= round.active ? 'success' : (round.completed ? 'secondary' : 'warning') %>">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Round <%= round.round_number %></h5>
          <% if round.judges.any? %>
            <button type="button"
                    class="btn btn-sm btn-outline-success"
                    data-bs-toggle="modal"
                    data-bs-target="#sendInstructionsModal<%= round.id %>">
              <i class="bi bi-envelope me-1"></i>Send judging instructions
            </button>
          <% end %>
          <span class="badge bg-<%= round.active ? 'success' : (round.completed ? 'secondary' : 'warning') %>">
            <%= round.active ? 'Active' : (round.completed ? 'Completed' : 'Pending') %>
          </span>
        </div>
        <div class="card-body">
          <div class="row mb-2">
            <div class="col">
              <strong><i class="bi bi-calendar me-1"></i> Dates:</strong>
              <%= format_datetime(round.start_date) %> - <%= format_datetime(round.end_date) %>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col">
              <div class="d-flex align-items-center">
                <strong class="me-3"><i class="bi bi-people me-1"></i> Judges Assigned:</strong>
              </div>
                <div class="d-flex flex-wrap">
                  <% assignments = round.round_judge_assignments.active.includes(:user) %>
                  <% if assignments.any? %>
                    <% assignments.each do |assignment| %>
                      <% judge = assignment.user %>
                      <span class="badge bg-<%= assignment.instructions_sent_at ? 'success' : 'secondary' %> text-white me-2 mb-1 d-inline-flex align-items-center"
                            data-bs-toggle="tooltip"
                            data-bs-html="true"
                            data-bs-title="<%= h(judge.display_name_or_first_name_last_name) %><br><%= h(display_email(judge.email)) %><% if assignment.instructions_sent_at %><br><small>Instructions sent: <%= I18n.l(assignment.instructions_sent_at, format: :short) %></small><% end %>">
                        <%= judge.display_name_and_uid %>
                        <% if assignment.instructions_sent_at %>
                          <i class="bi bi-check-circle-fill ms-1" title="Instructions sent"></i>
                        <% end %>
                      </span>
                    <% end %>
                  <% else %>
                    <em class="text-muted">No judges assigned to this round</em>
                  <% end %>
                </div>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col">
              <strong class="me-3">Minimum entries to be evaluated per judge:</strong>
              <%= round.required_entries_count %>
            </div>
          </div>

          <div class="row flex justify-content-space-around mb-2">
              <strong>Comment requirements:</strong>
              <div class="col-4">
                <p class="ms-3 small">Internal:</strong>
                  <%= round.require_internal_comments ? 'Required' : 'Optional' %>
                  <% if round.require_internal_comments && round.min_internal_comment_words > 0 %>
                    (minimum <%= pluralize(round.min_internal_comment_words, 'word') %>)
                  <% end %>
                </p>
              </div>
              <div class="col-4">
                <p class="ms-3 small">External:</strong>
                  <%= round.require_external_comments ? 'Required' : 'Optional' %>
                  <% if round.require_external_comments && round.min_external_comment_words > 0 %>
                    (minimum <%= pluralize(round.min_external_comment_words, 'word') %>)
                  <% end %>
                </p>
              </div>
          </div>

          <% if round.special_instructions.present? %>
            <div class="row">
              <div class="col">
                <div class="alert alert-warning mb-0">
                  <strong><i class="bi bi-exclamation-circle me-1"></i>Instructions:</strong><br>
                  <%= simple_format(round.special_instructions) %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Modal for selecting judges to send instructions -->
      <div class="modal fade" id="sendInstructionsModal<%= round.id %>" tabindex="-1" aria-labelledby="sendInstructionsModalLabel<%= round.id %>" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <%= form_with url: send_instructions_container_contest_description_contest_instance_judging_round_path(
                  @container, @contest_description, contest_instance, round
                ),
                method: :post,
                data: {
                  controller: "checkboxselect",
                  action: "submit->checkboxselect#submitForm",
                  checkboxselect_error_text_value: "Please select at least one judge."
                } do |f| %>
              <div class="modal-header">
                <h5 class="modal-title" id="sendInstructionsModalLabel<%= round.id %>">
                  Send Judging Instructions - Round <%= round.round_number %>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p class="mb-3">Select which judges should receive the judging instructions email:</p>
                <div class="form-check mb-3">
                  <%= check_box_tag "select_all_#{round.id}",
                       "1",
                       false,
                       class: "form-check-input",
                       data: {
                         checkboxselect_target: "checkboxAll",
                         action: "change->checkboxselect#toggleCheckbox"
                       } %>
                  <%= label_tag "select_all_#{round.id}", "Select All", class: "form-check-label" %>
                </div>
                <hr>
                <div data-checkboxselect-target="errorMessage" class="text-danger mb-2"></div>
                <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                  <% assignments = round.round_judge_assignments.active.includes(:user) %>
                  <% assignments.each do |assignment| %>
                    <% judge = assignment.user %>
                    <div class="form-check mb-2">
                      <%= check_box_tag "judge_assignment_ids[]",
                           assignment.id,
                           false,
                           id: "judge_assignment_#{assignment.id}",
                           class: "form-check-input",
                           data: {
                             checkboxselect_target: "checkbox",
                             action: "change->checkboxselect#toggleCheckboxAll"
                           } %>
                      <div class="d-flex align-items-center">
                        <%= label_tag "judge_assignment_#{assignment.id}",
                             judge.display_name_and_uid,
                             class: "form-check-label me-2" %>
                        <% if assignment.instructions_sent_at %>
                          <span class="badge bg-success text-white ms-2">
                            <i class="bi bi-check-circle me-1"></i>Sent <%= I18n.l(assignment.instructions_sent_at, format: :short) %>
                          </span>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <%= f.submit "Send Instructions", class: "btn btn-success" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
